name: CI/CD - Frontend (Netlify) + Backend (Render) + Smoke Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # safe to set defaults here — override via GitHub Secrets or repo env if needed
  NETLIFY_DIR: frontend
  PYTHON_VERSION: "3.11"

jobs:
  frontend:
    name: Build & Deploy Frontend → Netlify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        working-directory: ${{ env.NETLIFY_DIR }}
        run: |
          npm ci

      - name: Lint (frontend)
        working-directory: ${{ env.NETLIFY_DIR }}
        run: |
          npm run lint || true

      - name: Build (frontend)
        working-directory: ${{ env.NETLIFY_DIR }}
        run: |
          npm run build

      - name: Run frontend tests (if any)
        working-directory: ${{ env.NETLIFY_DIR }}
        run: |
          if [ -f package.json ]; then
            if npm run -s test --silent; then
              echo "Frontend tests passed"
            else
              echo "No frontend tests or tests failed (skipping)"; exit 0
            fi
          fi

      - name: Deploy to Netlify (via CLI action)
        uses: netlify/actions/cli@v3
        with:
          args: deploy --dir=./.next --prod --site-id=${{ secrets.NETLIFY_SITE_ID }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: Set frontend deployment output
        run: echo "FRONTEND_DEPLOY_URL=https://${{ secrets.NETLIFY_SITE_ID }}" >> $GITHUB_OUTPUT

  backend:
    name: Build & Trigger Render Deploy
    runs-on: ubuntu-latest
    needs: frontend
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Lint backend (optional)
        working-directory: backend
        run: |
          # add linters as you prefer (flake8/ruff) — skip if not present
          if command -v ruff >/dev/null 2>&1; then
            ruff check . || true
          fi

      - name: Run backend unit tests (if any)
        working-directory: backend
        run: |
          if [ -d backend/tests ]; then
            python -m pytest -q
          else
            echo "No backend tests detected — skipping"
          fi

      - name: Trigger Render deploy via API
        id: render_deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          GIT_BRANCH: ${{ github.ref_name }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "RENDER_API_KEY or RENDER_SERVICE_ID not set — skipping Render deploy"
            exit 1
          fi

          echo "Triggering Render deploy for service: $RENDER_SERVICE_ID branch: $GIT_BRANCH"

          DEPLOY_RESPONSE=$(curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"clearCache\":false, \"branch\":\"${GIT_BRANCH}\"}")

          echo "Render response: $DEPLOY_RESPONSE"
          echo "::set-output name=response::$DEPLOY_RESPONSE"

  smoke_test:
    name: Smoke Test (health check)
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    timeout-minutes: 15
    steps:
      - name: Wait for backend to warm up and poll /health
        env:
          HEALTH_URL: ${{ secrets.HEALTHCHECK_URL }}
        run: |
          if [ -z "$HEALTH_URL" ]; then
            echo "HEALTHCHECK_URL secret not provided, skipping smoke tests"
            exit 1
          fi

          echo "Polling $HEALTH_URL up to 15 times, interval 10s..."
          n=0
          until [ $n -ge 15 ]
          do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            echo "Attempt $((n+1)): HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed"
              exit 0
            fi
            n=$((n+1))
            sleep 10
          done

          echo "Health check failed after retries"
          exit 1
